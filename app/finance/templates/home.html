{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - {{ year }}/{{ month|stringformat:"02d" }}{% endblock %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'css/src/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="container-fluid">
        <div class="month-nav-section">
            <div class="month-nav">
                <a href="{% url 'home_with_date' year=prev_year month=prev_month %}" class="btn-month-nav">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M11.354 1.646a.5.5 0 0 1 0 .708L5.707 8l5.647 5.646a.5.5 0 0 1-.708.708l-6-6a.5.5 0 0 1 0-.708l6-6a.5.5 0 0 1 .708 0z"/>
                    </svg>
                </a>
                <span class="current-month">{{ month_name }} {{ year }}</span>
                <a href="{% url 'home_with_date' year=next_year month=next_month %}" class="btn-month-nav">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </a>
            </div>
        </div>

        {% include 'partials/monthly_summary_cards.html' %}

        <div class="charts-section mb-4">
            <h2 class="section-title">Budget Overview</h2>
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <div class="chart-container">
                        <h3 class="chart-title">Income Allocation</h3>
                        <canvas id="unallocatedIncomeChart" role="img" aria-label="Doughnut chart showing allocated income versus unallocated income as percentages of total budgeted income"></canvas>
                        <div class="visually-hidden" aria-live="polite">
                            Income allocation summary: Total income is ${{ unallocated_income_data.total_income|floatformat:2 }}. 
                            Allocated amount is ${{ unallocated_income_data.total_allocated|floatformat:2 }} 
                            which is {{ unallocated_income_data.percent_allocated|floatformat:1 }} percent. 
                            Unallocated amount is ${{ unallocated_income_data.unallocated|floatformat:2 }}.
                        </div>
                        <div class="chart-mobile-alternative">
                            <div class="mobile-chart-item">
                                <span class="mobile-chart-label">Total Income:</span>
                                <span class="mobile-chart-value">${{ unallocated_income_data.total_income|floatformat:2 }}</span>
                            </div>
                            <div class="mobile-chart-item">
                                <span class="mobile-chart-label">Allocated:</span>
                                <span class="mobile-chart-value">${{ unallocated_income_data.total_allocated|floatformat:2 }}</span>
                            </div>
                            <div class="mobile-chart-item">
                                <span class="mobile-chart-label">Unallocated:</span>
                                <span class="mobile-chart-value">${{ unallocated_income_data.unallocated|floatformat:2 }}</span>
                            </div>
                            <div class="mobile-chart-item">
                                <span class="mobile-chart-label">Percent Allocated:</span>
                                <span class="mobile-chart-value">{{ unallocated_income_data.percent_allocated|floatformat:1 }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="chart-container">
                        <h3 class="chart-title">Budget Distribution</h3>
                        <canvas id="budgetDistributionChart" role="img" aria-label="Pie chart displaying budget allocation across five categories: Needs, Wants, Debts, Savings, and Investing"></canvas>
                        <div class="visually-hidden" aria-live="polite">
                            Budget distribution summary: 
                            {% if budget_distribution_data %}
                                {% for type, amount in budget_distribution_data.items %}
                                    {{ type }} is ${{ amount|floatformat:2 }}{% if not forloop.last %}, {% else %}.{% endif %}
                                {% endfor %}
                            {% else %}
                                No budgets have been allocated yet.
                            {% endif %}
                        </div>
                        <div class="chart-mobile-alternative">
                            {% if budget_distribution_data %}
                                {% for type, amount in budget_distribution_data.items %}
                                <div class="mobile-chart-item">
                                    <span class="mobile-chart-label">{{ type }}:</span>
                                    <span class="mobile-chart-value">${{ amount|floatformat:2 }}</span>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted text-center mb-0">No budgets allocated yet</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="budget-section mb-4">
            <h2 class="section-title">Budget Tracking</h2>
            {% include 'partials/budget_tabs.html' %}
        </div>

        {% include 'partials/transaction_section.html' %}
    </div>
</div>

{% include 'partials/budget_form_modal.html' %}
{% include 'partials/budget_delete_modal.html' %}
{% include 'partials/transaction_form_modal.html' %}
{% include 'partials/transaction_delete_modal.html' %}
{% endblock %}

{% block extra_scripts %}
    <script src="{% static 'js/lib/chart.js' %}"></script>
    <script id="chart-data" type="application/json">
{
    "unallocatedIncome": {
        "totalIncome": "{{ unallocated_income_data.total_income }}",
        "totalAllocated": "{{ unallocated_income_data.total_allocated }}",
        "unallocated": "{{ unallocated_income_data.unallocated }}",
        "percentAllocated": {{ unallocated_income_data.percent_allocated }}
    },
    "budgetDistribution": {
        {% for type, amount in budget_distribution_data.items %}
        "{{ type }}": "{{ amount }}"{% if not forloop.last %},{% endif %}
        {% endfor %}
    }
}
    </script>
    <script src="{% static 'js/src/charts.js' %}"></script>
    <script src="{% static 'js/src/dashboard.js' %}"></script>
{% endblock %}
